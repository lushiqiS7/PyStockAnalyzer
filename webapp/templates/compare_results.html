{% extends "base.html" %}
{% block title %}Compare Stocks{% endblock %}

{% block content %}
<div class="results-header">
  <h2>📊 Stock Price Comparison</h2>
  <p class="analysis-date">Compared on: {{ analysis_date }}</p>
</div>

<div class="chart-container" style="width: 90%; max-width: 900px; margin: 2rem auto;">
  <canvas id="closingPricesChart"></canvas>
</div>

<div class="chart-container" style="width: 90%; max-width: 900px; margin: 2rem auto;">
  <h3>RSI</h3>
  <canvas id="rsiChart"></canvas>
</div>


<script>
  // Pass data from Flask to JS
  const chartData = {{ all_charts | tojson | safe }};
  const dates = chartData[Object.keys(chartData)[0]].dates;

  // Generate random colors for datasets
  function getRandomColor() {
    return '#' + Math.floor(Math.random() * 16777215).toString(16);
  }

  function prepareDatasets(key, chartType = 'line', fill = false) {
    const datasets = Object.entries(chartData).map(([ticker, data]) => ({
      label: ticker,
      data: data[key],
      borderColor: getRandomColor(),
      backgroundColor: fill ? 'rgba(100, 149, 237, 0.5)' : undefined,
      fill: fill,
      tension: 0.1,
      type: chartType
    }));
    
    // Add run highlighting datasets for each ticker if showing prices
    if (key === 'prices') {
      Object.entries(chartData).forEach(([ticker, data]) => {
        if (data.runs) {
          // Add upward runs background
          const upRuns = data.runs.filter(run => run.direction === 'up');
          if (upRuns.length > 0) {
            datasets.push({
              label: `${ticker} Upward Runs`,
              data: createRunBackgroundData(dates, data[key], upRuns),
              type: 'bar',
              backgroundColor: 'rgba(0, 255, 0, 0.1)',
              borderColor: 'transparent',
              order: 10
            });
          }
          
          // Add downward runs background
          const downRuns = data.runs.filter(run => run.direction === 'down');
          if (downRuns.length > 0) {
            datasets.push({
              label: `${ticker} Downward Runs`,
              data: createRunBackgroundData(dates, data[key], downRuns),
              type: 'bar',
              backgroundColor: 'rgba(255, 0, 0, 0.1)',
              borderColor: 'transparent',
              order: 10
            });
          }
        }
      });
    }
    
    return datasets;
  }

  // Function to create background data for run highlighting
  function createRunBackgroundData(dates, prices, runs) {
    const backgroundData = dates.map(() => null);
    
    runs.forEach(run => {
      const startIdx = dates.indexOf(run.start);
      const endIdx = dates.indexOf(run.end);
      
      if (startIdx !== -1 && endIdx !== -1) {
        const periodPrices = prices.slice(startIdx, endIdx + 1).filter(p => p !== null);
        const minPrice = Math.min(...periodPrices);
        const maxPrice = Math.max(...periodPrices);
        
        for (let i = startIdx; i <= endIdx; i++) {
          backgroundData[i] = maxPrice * 1.02;
        }
      }
    });
    
    return backgroundData;
  }

  // Closing Prices Chart
  const closingCtx = document.getElementById("closingPricesChart").getContext("2d");
  new Chart(closingCtx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: prepareDatasets('prices')
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: 'white' } },
        title: {
          display: true,
          text: 'Closing Prices Comparison',
          color: 'white',
          font: { size: 18 }
        }
      },
      scales: {
        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
        y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
      }
    }
  });

  // RSI Chart
  const rsiCtx = document.getElementById("rsiChart").getContext("2d");
  new Chart(rsiCtx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: prepareDatasets('rsi')
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: 'white' } },
        title: {
          display: true,
          text: 'Relative Strength Index (RSI)',
          color: 'white',
          font: { size: 18 }
        }
      },
      scales: {
        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
        y: {
          ticks: { color: 'white' },
          grid: { color: 'rgba(255,255,255,0.1)' },
          min: 0,
          max: 100
        }
      }
    }
  });

</script>

<div class="comparison-grid">
  {% for result in all_results %}
    <div class="result-card">
      <h3>{{ result.ticker }}</h3>
      <p><strong>Current Price:</strong> ${{ result.current_price }}</p>
      <p><strong>Total Change:</strong> {{ result.total_change }}%</p>
      <p><strong>SMA({{ result.sma_window }}):</strong> ${{ result.sma_current }}</p>
      <p><strong>RSI:</strong> {{ result.rsi_current }} ({{ result.rsi_status }})</p>
      <p><strong>Volatility:</strong> {{ result.volatility }}</p>
      <p><strong>Max Profit:</strong> ${{ result.max_profit }}</p>
      <p><strong>Score:</strong> {{ result.score }}</p>
    </div>
  {% endfor %}
</div>

{% if recommended_ticker %}
<div class="result-card highlight-card" style="margin-top: 2rem;">
  <h3>🔍 Conclusion</h3>
  <p>After analyzing performance, risk, and RSI indicators, <strong>{{ recommended_ticker }}</strong> stands out as the best stock.</p>
  <p>🏆 It scored the highest overall (score: <strong>{{ best_score }}</strong>) among all compared stocks.</p>
  <p>✅ Recommendation based on: {{ recommendation_reason }}.</p>
</div>
{% else %}
<div class="result-card" style="margin-top: 2rem;">
  <h3>🔍 Conclusion</h3>
  <p>No clear winner found. Please review the stock data or adjust your criteria.</p>
</div>
{% endif %}

<div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">

<a href="{{ url_for('index') }}" class="btn btn-primary" style="margin-top: 2rem;">← Return to Home</a>

<form method="POST" action="{{ url_for('analyze_or_compare') }}" style="margin-top: 2rem;">
    <input type="hidden" name="tickers" value="{{ all_results | map(attribute='ticker') | join(',') }}">
    <input type="hidden" name="mode" value="compare">
    <button type="submit" class="btn btn-secondary">🔄 Refresh Data</button>
  </form>
</div>
  
{% endblock %}
